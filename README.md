# Terraform скрипт

## Задание

1. Подготовка окружения:

    - Убедитесь, что **Terraform** установлен на вашей локальной машине или в окружении, где вы будете работать.
    - Настройте доступ к облачному провайдеру, создав учетные данные и добавив их в **Terraform**.

2. Создание **Terraform** файла:

    - Создайте новый файл `main.tf`.
    - Определите провайдера, который вы будете использовать, и укажите учетные данные для доступа к нему.
    - Настройте ресурс для виртуальной машины.

3. Настройка инфраструктуры:

    - Укажите параметры для виртуальной машины: тип, регион, операционную систему и конфигурацию сети.
    - Добавьте секцию **output**, которая покажет IP-адрес созданной виртуальной машины после выполнения скрипта.

4. Инициализация и запуск:

    - Запустите команду `terraform init` для инициализации проекта.
    - Проверьте корректность кода командой `terraform plan`.
    - Запустите `terraform apply`, чтобы создать виртуальную машину.

5. Проверка результата:

    - Убедитесь, что виртуальная машина создана, и вы получили ее IP-адрес.
    - Подключитесь к машине по SSH для подтверждения ее доступности.

6. Документация:

    - Опишите процесс создания скрипта и конфигурации.
    - Укажите инструкции по воспроизведению.

## Реализация

Скрипт состоит из нескольких файлов:

- [terraform.tf](terraform.tf) - содержит список используемых провайдеров и их версии;
- [providers.tf](providers.tf) - содержит настройки провайдера **Yandex Cloud**;
- [variables.tf](variables.tf) - содержит описания используемых переменных;
- [outputs.tf](outputs.tf) - содержит код, возвращающий IP адреса создаваемых машин;
- [main.tf](main.tf) - содержит описания создаваемых машин.

Также написаны шаблоны:

- [cloud-config.tftpl](cloud-config.tftpl) - конфигурация **cloud init** для создаваемых машин;
- [inventory.tftpl](inventory.tftpl) - шаблон инвентартного файла `inventory.yml` для **ansible**;

Помимо этого написаны скрпипты для автоматизации запуска:

- [update-tfvars.sh](update-tfvars.sh) - генерирует SSH ключ `secrets/yandex-cloud` для подключения к машине создаёт файл секретов `terraform.tfvars` на основании переменных, указанных в скрипте:

  - **PROJECT** - название проекта (имена для виртуальных машин);
  - **ZONE** - используемая зона в **Yandex Cloud**;
  - **TOKEN** - токен для подключения к **Yandex Cloud**;
  - **CLOUD_ID** - идентификатор облака;
  - **FOLDER_ID** - идентификатор каталога;
  - **SSH_USERNAME** - имя пользователя администратора (`ansible`);
  - **SSH_KEY_FILE** - путь к **SSH** ключю для подключения к машине.

- [provision.sh](provision.sh) - запускает `ansible-playbook provision.yml`;
- [up.sh](up.sh) - выполняет все действия, необходимые для создания и настройки машины:

  - [update-tfvars.sh](update-tfvars.sh);
  - `terraform init`
  - `terraform plan`
  - `terraform apply -auto-approve`
  - [provision.sh](provision.sh)

Файл `provision.yml` в свою очередь запускает две роли:

- **wait_connection** - ожидает доступности машин;
- **nginx** - устанавливает nginx.

Общие переменные для **ansible** находятся в [group_vars/all.yml](group_vars/all.yml).

По умолчанию **yandex_compute_instance** используется значение **standard-v1** для атрибута **platform_id**, однако оно недопустимо для зоны **ru-central1-d**, поэтому необходимо явно задавать это значение в **standard-v2** или **standard-v3** для этой зоны.

## Запуск

1. Необходимо установить и настроить утилиту **yc** по инструкции [Начало работы с интерфейсом командной строки](https://yandex.cloud/ru/docs/cli/quickstart).
2. Необходимо установить **Terraform** по инструкции [Начало работы с Terraform](https://yandex.cloud/ru/docs/tutorials/infrastructure-management/terraform-quickstart).
3. Необходимо установить **Ansible**.
4. Необходимо перейти в папку проекта и запустить скрипт [up.sh](up.sh).

Протестировано в **OpenSUSE Tumbleweed**:

- **Ansible 2.18.2**
- **Python 3.11.11**
- **Jinja2 3.1.5**

## Проверка

Запустим скрипт [up.sh](up.sh):

```text

```
